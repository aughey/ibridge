function createRemoteConnection(e,t,n){function i(e){function t(e){r.emit("data",new Buffer(e.d,"binary"))}o.write=function(t){server.sendMessage({c:e.i,s:s.id,d:t.toString("binary")})},o.close=function(){server.sendMessage({c:"x",i:e.i}),s.close()},o.end=o.close,s.setCallback(t),n()}var r=new events.EventEmitter,s=server.newEndpoint(null,i,function(){r.emit("close")}),o={on:function(){r.on.apply(r,arguments)},removeAllListeners:function(){r.removeAllListeners.apply(r,arguments)},end:function(){s.close()}};return server.sendMessage({c:"open",i:s.id,host:t,port:e}),o}var common=require("./common"),net=require("net"),events=require("events"),argv=require("optimist")["default"]({p:3e3}).demand("s").describe("s","server address.  eg. http://server.slicehost.com:3001").describe("p","Local http server port").argv,server=common.newServer(argv.p,[["/serveraddress",argv.s]]);server.newEndpoint("p",function(){});var net=require("net"),socks=require("./socks.js"),HOST="127.0.0.1",PORT="8888",socksserver=socks.createServer(function(e,t,n,r){var i=createRemoteConnection(t,n,r);i.on("data",function(t){e.write(t)}),e.on("data",function(e){i.write(e)}),i.on("close",function(t){e.end()}.bind(this)),e.on("close",function(e){i.removeAllListeners("data"),i.end()}.bind(this))});socksserver.on("error",function(e){e.code=="EADDRINUSE"&&setTimeout(function(){server.close(),server.listen(PORT,HOST)},1e4)}),socksserver.listen(PORT,HOST);