var common=require("./common"),net=require("net"),argv=require("optimist")["default"]({p:3e3,e:null}).demand("s").describe("e",'command to run when tunnel is active.  eg.  "ssh -N localhost -D 11111 -p 12345"').describe("s","Remote server url").argv,io=common.newServer(argv.p,[["/serveraddress",argv.s]]),handle_connect=function(e){io.sockets.removeListener("connection",handle_connect);var t=null,n=net.createServer();n.on("connection",function(r){t=r,n.close(),e.emit("data",{c:"c"}),r.on("data",function(t){t&&t.length>0&&e.emit("data",{c:"d",d:t.toString("binary")})});var i=function(e){e["c"]=="d"?r.write(new Buffer(e.d,"binary")):e["c"]=="x"&&r.destroy()};r.on("end",function(){e.emit("data",{c:"x"}),e.removeListener("data",i),t=null,n.listen(12345,"127.0.0.1")}),e.on("data",i)}),n.listen(12345,"127.0.0.1"),e.on("disconnect",function(){t&&t.destroy(),n.close(),n=null,io.sockets.on("connection",handle_connect)})};io.sockets.on("connection",handle_connect);